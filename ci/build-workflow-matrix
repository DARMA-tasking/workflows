#!/usr/bin/env python

import copy
import os
import json
import sys

from util import resolve_conf
import yaml

AZURE_PIPELINES_OUTPUT_DIR="ci/azure"
GITHUB_PIPELINES_OUTPUT_DIR=".github/workflows"

class MatrixGenerator:
    """MatrixGenerator class for CI pipelines"""

    def generate(self):
        """Generate a matrix of runners and inner environments to be used by CI pipelines"""

        raw_config: dict = {}
        with open(os.path.dirname(__file__) + '/config.yaml', 'r', encoding="utf-8") as file:
            raw_config = yaml.safe_load(file)
        config = resolve_conf(copy.deepcopy(raw_config))

        image_tags = dict((k, v.get("repository") + ":" + k)
                           for k, v in config.get("images").items())

        for runner_type in ["github", "azure-pipelines"]:
            runners = [{
                "id": k,
                "runs-on": v.get("runs-on"),
                "environment_setup": v.get("environment_setup"),
                "image": image_tags.get(v.get("image"))
                } for k, v in config.get("runners").items() if v.get("type") == runner_type]

            data = json.dumps({
                "_comment": "This file has been generated. Do not edit",
                "matrix": runners}, indent=2)
            with open(os.path.dirname(__file__) + f"/shared/{runner_type}-matrix.json", 'w+', encoding="utf-8") as file:
                file.write(data)

MatrixGenerator().generate()
